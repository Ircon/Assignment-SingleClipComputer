#include<reg52.h>								//52????????
#define uint unsigned int							//??????????
#define uchar unsigned char						//??????????

sbit DQ = P3^0;                				// ??DQ???P3.3

//????
void DS18_delay(int useconds) 
{
	int s;
	for (s=0; s<useconds;s++);					//????16us
}

//???????????
unsigned char ow_reset(void) 
{
	unsigned char presence;						// ????????(??)
	DQ = 0;  								// ? DQ ???
	DS18_delay(29); 							// ?? 480탎
	DQ = 1; 									// DQ?????
	DS18_delay(3); 							// ??????
	presence = DQ; 							// ??????(0-??,1-???)
	DS18_delay(25); 							// ???????
	return(presence); 							// ??????(0=????, 1=????)
}

//??????1??
void write_bit(char bitval) 
{
	DQ = 0; 									// ?DQ ????????
	if(bitval==1) DQ =1; 						// ???1,DQ ?????
	DS18_delay(5); 							// DS18_delay????16탎,??DS18_delay(5)=104탎
	DQ = 1; 									// ??????????
}

//???????????:
void ds18write_byte(char val) 
{
	unsigned char i;							// ????
	unsigned char t;							// ????
	for (i=0; i<8; i++) 							// ??????,??????8?,  
	{
		t =val & 0x01; 						// ????
		write_bit(t); 							// ??????1??
		val>>= 1; 							// ????i?
	}
	DS18_delay(5);							// ??
}

//?????
unsigned char read_bit(void) 
{
	unsigned char i;
	DQ = 0;     		 						// ?DQ ????????
	DQ = 1; 									// then return high
	for (i=0; i<3; i++); 						// ??15탎
	return(DQ); 								// ?? DQ ??????
}

//????????????
unsigned char DSread_byte(void) 
{
	unsigned char i;							// ????
	unsigned char value = 0;						// ????
	for (i=0;i<8;i++) 							// ??????(8?),
	{  										// ???????(??????)
		if(read_bit()) 							// ?????????1
		value|=0x01<<i; 						// ??????????1
		DS18_delay(6); 						// ??			
	}										// 8?????????
	return(value);								// ??????
}


//??????
unsigned int ReadTemperature(void) 
{
	unsigned char get[10];						// ????????
	unsigned char temp_msb,temp_lsb;			// ?????,?????
	unsigned int t;								// ??????
	unsigned char k;							// ????
	ow_reset();								// ??????
	ds18write_byte(0xCC); 						// ?? ROM
	ds18write_byte(0x44); 						// ??????
	DS18_delay(5);							// ??
	ow_reset();								// ????
	ds18write_byte(0xCC); 						// ?? ROM	??
	ds18write_byte(0xBE); 						// ????
	for (k=0;k<2;k++)							// ??2?(????,????)
	{get[k]=DSread_byte();}					// ?????????????(BCD?)

	temp_msb = get[1]; 						// ?????????(Sign byte + lsbit)
	temp_lsb = get[0]; 							// ?????????(Temp data plus lsb)

	t=temp_msb*256+temp_lsb;					// ???????????????
	t=t&0x0ff0;								// ???8???4???8???4?
	if(t<0xff&&t>0xf0)							// ??t??
	t=(-1)*t;									// ????(0~99?)
//	temp_f = (((int)temp_c)* 9)/5 + 32;			// ???????
	return t>>4;								// ?? t??4????(???16??????),
}