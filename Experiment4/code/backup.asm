;分配内存
;栈从 50H 开始
;30h 40h 随便用

; ---- RAM ----
REG_PRE 		DATA 	30H
REG_CNT 		DATA 	31H
T0_INT_DATA 	DATA 	32H

; ---- PIN ----
PIN_SOUND 		EQU 	P1.1
PIN_LED 		EQU 	P1.2

; ---- CODE ----
ORG 0000H
	LJMP INIT
;ORG 000BH
;	LJMP T0_INT

ORG 0030H
INIT:
	MOV SP,#50H
	MOV TMOD,#01H
	MOV TH0,#0C3H
	MOV TL0,#50H
	SETB ET0
	SETB EA
	SETB TR0
	
	LCALL DO_SOM_SET
	
	;FOR TEST
	MOV REG_PRE,#3
	
MAIN:
	;FOR TEST
	;LCALL T0_INT
	LJMP MAIN

; ---- FUN ----

; CLR BIT
DO_SOM_CLR:
	CLR PIN_SOUND
	CLR PIN_LED
	RET

; SETB BIT
DO_SOM_SET:
	SETB PIN_SOUND
	SETB PIN_LED
	RET

; 100HZ TO CALL
TIMER_CALL:
	
	PUSH ACC
	PUSH PSW
	
	
	MOV A,REG_CNT
	CJNE A,#10,TIMER_PRE
	MOV A,#0
	LCALL DO_SOM_SET
	LJMP TIMER_CALL_END
	
TIMER_PRE:
	JC TIMER_PRE_1
	
	MOV A,#0
	LCALL DO_SOM_SET
	LJMP TIMER_CALL_END
	
TIMER_PRE_1:
	CJNE A,REG_PRE,TIMER_CALL_END
	LCALL DO_SOM_CLR

TIMER_CALL_END:

	INC A
	MOV REG_CNT,A
	POP PSW
	POP ACC
	
	RET
	

; ---- INT FUN ----

; 600 HZ TO CALL
T0_INT:
	PUSH ACC
	PUSH PSW
	
	MOV TH0,#0C3H
	MOV TL0,#50H
	
	MOV A,T0_INT_DATA
	CJNE A,#6,T0_INT_INC
	LCALL TIMER_CALL
	MOV A,#0
	
T0_INT_INC:
	INC A
	MOV T0_INT_DATA,A
	
	
	POP PSW
	POP ACC
	
T0_INT_END:
	RETI